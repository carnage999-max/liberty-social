AUTHENTICATION SYSTEM IMPLEMENTATION - TODO & CONCLUSIONS
================================================================

DATE: 2025-12-08
STATUS: Planning Phase - Phased Rollout Approach Approved

================================================================
EXECUTIVE SUMMARY
================================================================

Decision: Implement passkey-based authentication system with phased rollout
approach, starting with passkeys as optional second authentication method.

Reasoning:
- Addresses supervisor's concern about account security and recovery
- Prevents users from losing access to accounts and years of data
- More secure than password-only systems (resistant to phishing, no password reuse)
- Gradual adoption prevents UX friction and low adoption rates
- Aligns with industry approach (Google, Microsoft rolling out passkeys gradually)

================================================================
PHASED IMPLEMENTATION PLAN
================================================================

PHASE 1: CORE PASSKEY SUPPORT (MVP)
-----------------------------------
Priority: HIGH
Timeline: 2-3 weeks
Status: Not Started

Features to Implement:
✓ Passkey registration endpoint (WebAuthn create)
✓ Passkey authentication endpoint (WebAuthn get)
✓ Enable/disable passkey in user security settings
✓ Login screen with "Sign in with Passkey" option (if enabled)
✓ Basic device tracking (store device info when passkey registered)
✓ Simple session management (track which device logged in)

Database Changes:
- Add passkey_credentials table (user_id, credential_id, public_key, device_info)
- Add device_id to sessions table
- Add has_passkey flag to users table

API Endpoints:
- POST /auth/passkey/register
- POST /auth/passkey/verify
- GET /auth/passkey/status
- DELETE /auth/passkey/remove

Frontend:
- Security settings page: "Enable Passkey" button
- Login page: Show passkey option if user has one enabled
- Mobile: Native passkey APIs (iOS/Android)
- Web: Browser WebAuthn APIs

Skip for Now:
- Device approval flows
- Recovery phrase
- Risk engine
- QR cards
- Trusted device concept

================================================================

PHASE 2: DEVICE & SESSION MANAGEMENT
-------------------------------------
Priority: MEDIUM
Timeline: 1-2 weeks (after Phase 1)
Status: Not Started

Features to Implement:
✓ Security settings page showing:
  - List of devices (name, OS, last seen, location)
  - Active sessions list
  - "Sign out of all other devices" button
  - "Remove device" functionality (revoke passkey)
✓ Device naming (let users name their devices)
✓ Session tracking (IP, location, user agent)
✓ Basic activity log (recent logins with location)

Database Changes:
- Enhance device tracking (device_name, last_seen, location, IP)
- Add session_history table
- Add device_removed_at timestamp

API Endpoints:
- GET /auth/devices/
- DELETE /auth/devices/{device_id}/
- POST /auth/sessions/revoke-all
- GET /auth/activity/

Frontend:
- Security settings page with device list
- Device management UI (rename, remove)
- Activity log view

Skip for Now:
- Trusted device approval flows
- Device fingerprinting
- Risk scoring
- Automatic device blocking

================================================================

PHASE 3: ADMIN TOOLS
-------------------------------------
Priority: MEDIUM
Timeline: 1 week (can be parallel to Phase 2)
Status: Not Started

Features to Implement:
✓ Admin dashboard security section:
  - View user security status (has passkey, has recovery phrase)
  - View user devices (read-only)
  - View recent login activity
  - Account lock/unlock functionality (with audit log)
✓ Security event logs (login attempts, device changes)
✓ Cannot reset passwords or recovery phrases (user must use recovery)

Database Changes:
- Add security_events table (audit log)
- Add account_locked_at, locked_reason to users table

API Endpoints:
- GET /admin/users/{user_id}/security/
- GET /admin/users/{user_id}/devices/
- GET /admin/users/{user_id}/activity/
- POST /admin/users/{user_id}/lock/
- POST /admin/users/{user_id}/unlock/

Frontend:
- Admin dashboard security section
- User security details view
- Account lock/unlock UI

Skip for Now:
- Manual account recovery by admins
- Override user security settings
- Bulk security operations

================================================================

PHASE 4: RECOVERY PHRASE (LATER)
-------------------------------------
Priority: LOW (Future)
Timeline: 2-3 weeks (when adoption is higher)
Status: Not Started

Features to Implement:
✓ Generate 12-word recovery phrase during signup/security setup
✓ Require confirmation (select 2-3 words in order)
✓ Store hashed phrase (argon2/scrypt) - NEVER plaintext
✓ "Restore account with recovery phrase" flow
✓ Option to regenerate phrase (invalidates old one, requires confirmation)

Database Changes:
- Add recovery_phrase_hash to users table
- Add recovery_phrase_created_at, last_verified_at
- Add recovery_attempts table (rate limiting)

API Endpoints:
- POST /auth/recovery/generate-phrase
- POST /auth/recovery/verify-phrase
- POST /auth/recovery/restore-account
- POST /auth/recovery/regenerate-phrase

Frontend:
- Recovery phrase setup UI (with word confirmation)
- Restore account with recovery phrase flow
- Regenerate phrase in security settings

Skip for Now:
- QR recovery cards
- Trusted device approval for recovery
- 7-day reset option

================================================================
TECHNICAL REQUIREMENTS
================================================================

Backend:
- WebAuthn library (python-webauthn or similar)
- Argon2/scrypt for recovery phrase hashing
- Device fingerprinting library (optional, Phase 2+)
- IP geolocation service (for location display)

Frontend:
- WebAuthn API support (browser compatibility check)
- Native passkey APIs for mobile (iOS/Android)
- Secure storage for passkey credentials

Security:
- All recovery data must be hashed (never plaintext)
- Rate limiting on recovery attempts
- Session tokens must be device-bound
- Audit logging for all security events

================================================================
DECISIONS MADE
================================================================

✓ Passkeys as OPTIONAL second authentication method (not replacing passwords)
✓ Phased rollout approach (not all features at once)
✓ Recovery phrase in Phase 4 (later, when adoption is higher)
✓ Skip device approval flows initially (add later if needed)
✓ Skip QR recovery cards (recovery phrase is sufficient)
✓ Skip risk engine initially (add basic anomaly detection later if needed)
✓ Admin tools can view but cannot override user security
✓ No manual password resets by admins (users must use recovery)

================================================================
NOTES
================================================================

- Supervisor's concern: Users losing access to accounts and years of data
- Solution: Passkeys are more secure + recovery features in later phases
- Industry approach: Google, Microsoft rolling out passkeys gradually
- User adoption: Gradual rollout prevents UX friction

================================================================
NEXT STEPS
================================================================

1. Finalize website features to match mobile app (current priority)
2. Begin Phase 1 implementation (passkeys as optional)
3. Monitor adoption and user feedback
4. Plan Phase 2 based on Phase 1 results

================================================================

